name: Claude Bugfix Guard

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number

jobs:
  bugfix-guard:
    if: |
      (github.event.label.name == 'bug') ||
      (github.event.comment.body == '@claude fix-bug') ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright
        run: npx playwright install chromium
        
      - name: Extract issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || 
                               context.payload.inputs?.issue_number;
            
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Extract bug description and steps to reproduce
            const description = issue.body || '';
            const title = issue.title;
            
            // Save for next steps
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', title);
            core.setOutput('issue_body', description);
            
            return { issueNumber, title, description };
            
      - name: Generate failing test
        id: generate-test
        run: |
          # Create test file based on issue
          cat > tests/api/bugs/issue-${{ steps.issue.outputs.issue_number }}.test.ts << 'EOF'
          import { test, expect } from '@playwright/test'
          
          test.describe('Bug #${{ steps.issue.outputs.issue_number }}: ${{ steps.issue.outputs.issue_title }}', () => {
            test('should reproduce the bug', async ({ page }) => {
              // This test should fail until the bug is fixed
              // Bug description: ${{ steps.issue.outputs.issue_body }}
              
              // TODO: Implement failing test based on bug report
              expect(true).toBe(false) // Placeholder - replace with actual test
            })
          })
          EOF
          
      - name: Run failing test
        id: run-failing
        continue-on-error: true
        run: |
          npx playwright test tests/api/bugs/issue-${{ steps.issue.outputs.issue_number }}.test.ts
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          
      - name: Verify test fails
        run: |
          if [ "${{ steps.run-failing.outputs.exit_code }}" == "0" ]; then
            echo "Error: Test should fail to reproduce the bug"
            exit 1
          fi
          echo "✅ Test correctly fails, reproducing the bug"
          
      - name: Claude generates fix
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Fix bug #${{ steps.issue.outputs.issue_number }}: ${{ steps.issue.outputs.issue_title }}
            
            Description: ${{ steps.issue.outputs.issue_body }}
            
            The failing test is in tests/api/bugs/issue-${{ steps.issue.outputs.issue_number }}.test.ts
            
            Generate a MINIMAL fix that makes the test pass.
            Follow the CLAUDE.md guidelines for minimal diffs.
          max-diff-size: 500
          
      - name: Apply fix
        run: |
          # Apply the fix generated by Claude
          git apply claude-fix.patch || echo "No patch to apply"
          
      - name: Run test again
        id: run-fixed
        run: |
          npx playwright test tests/api/bugs/issue-${{ steps.issue.outputs.issue_number }}.test.ts
          
      - name: Run full test suite
        run: |
          npm test
          
      - name: Create PR if tests pass
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: Bug #${{ steps.issue.outputs.issue_number }} - ${{ steps.issue.outputs.issue_title }}"
          title: "🐛 Fix: Bug #${{ steps.issue.outputs.issue_number }}"
          body: |
            ## Bug Fix
            
            Fixes #${{ steps.issue.outputs.issue_number }}
            
            ### Changes
            - Generated failing test to reproduce the bug
            - Applied minimal fix to make test pass
            - Verified all existing tests still pass
            
            ### Test Results
            - ✅ Bug reproduction test now passes
            - ✅ All existing tests pass
            
            ### Verification
            1. The test in `tests/api/bugs/issue-${{ steps.issue.outputs.issue_number }}.test.ts` reproduces the bug
            2. The fix is minimal and targeted
            3. No regressions introduced
            
            ---
            *Generated by Claude Bugfix Guard*
          branch: fix/bug-${{ steps.issue.outputs.issue_number }}
          delete-branch: true
          labels: |
            bugfix
            automated
            
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: ${{ steps.issue.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `🤖 **Claude Bugfix Guard**
              
              ✅ Successfully reproduced and fixed the bug!
              
              - Created failing test: \`tests/api/bugs/issue-${{ steps.issue.outputs.issue_number }}.test.ts\`
              - Applied minimal fix
              - All tests passing
              
              PR created: #${{ steps.create-pr.outputs.pull-request-number }}
              
              The fix will be merged once reviewed.`
            })