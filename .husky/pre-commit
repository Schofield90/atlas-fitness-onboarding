echo "ğŸ” Running pre-commit checks..."

# 1. Run type checking
echo "ğŸ“‹ Type checking..."
npm run type-check || {
  echo "âŒ Type checking failed. Please fix TypeScript errors."
  exit 1
}

# 2. Run linting
echo "ğŸ§¹ Linting..."
npm run lint || {
  echo "âŒ Linting failed. Run 'npm run lint:fix' to fix issues."
  exit 1
}

# 3. Run security validation
echo "ğŸ” Security validation..."
npx tsx scripts/validate-existing-db.ts --quick || {
  echo "âŒ Security validation failed. Check for organization isolation issues."
  exit 1
}

# 4. Check for sensitive data
echo "ğŸ” Checking for sensitive data..."
git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    # Check for API keys, passwords, etc.
    if grep -E "(sk-[a-zA-Z0-9]{48}|pk_test_|sk_test_|password\s*=|api[_-]?key\s*=)" "$file" > /dev/null; then
      echo "âŒ Found potential sensitive data in $file"
      echo "   Please remove API keys, passwords, and secrets before committing."
      exit 1
    fi
  fi
done

# 5. Check migration files
echo "ğŸ“ Checking migration files..."
git diff --cached --name-only | grep -E "migrations/.*\.sql$" | while read file; do
  if [ -f "$file" ]; then
    npx tsx scripts/migration-validator.ts "$file" || {
      echo "âŒ Migration validation failed for $file"
      exit 1
    }
  fi
done

echo "âœ… All pre-commit checks passed!"